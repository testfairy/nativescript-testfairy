name: Release TestFairy Nativescript SDK
on:
  push:
    tags:
      - '*.*.*'

jobs:
  release:
    runs-on: macos-latest
    timeout-minutes: 30
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-node@v2
      with:
        node-version: '15.12.0'
    - name: Install Dependencies
      run: |
        brew install carthage
        npm install -g nativescript@7.0.11
        tns usage-reporting disable
        tns error-reporting disable
    - name: Update iOS SDK
      run: |
        carthage update
        rm -rf src/platforms/ios/TestFairySDK.*
        cp -R Carthage/Build/iOS/TestFairy.framework* src/platforms/ios/.
        rm -rf Carthage
      - name: Release Nativescript to npm
        run: |
          cd ../publish
          sh pack.sh
          cd package
          npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}